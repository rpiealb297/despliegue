pipeline {
    agent any

    stages {
        stage('Checkout') {
            steps {
                // Clona el repo con el c칩digo React
                git url: 'https://github.com/rpiealb297/despliegue.git'
            }
        }

        stage('Build') {
            steps {
                // Copia el c칩digo al contenedor Node
                sh 'docker exec node_builder rm -rf /usr/src/app/*'
                sh 'docker cp . node_builder:/usr/src/app'
                
                // Instala dependencias y compila la app
                sh '''
                    docker exec node_builder bash -c "
                        cd /usr/src/app && \
                        npm install && \
                        npm run build
                    "
                '''
            }
        }

        stage('Test') {
            steps {
                // Ejecuta los tests en el contenedor Node
                sh '''
                    docker exec node_builder bash -c "
                        cd /usr/src/app && \
                        npm test
                    "
                '''
            }
        }

        stage('Deploy') {
            steps {
                // La carpeta 'build' ya est치 en el volumen compartido,
                // Apache la sirve autom치ticamente.
                echo "Despliegue completado. Revisa el contenedor Apache."
            }
        }
    }
}
