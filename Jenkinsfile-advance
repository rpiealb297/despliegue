pipeline {
    agent any

    stages {
        stage('Build') {
            steps {
                // Copia el código al contenedor Node
                sh 'docker exec node_builder rm -rf /usr/src/app/*'
                sh 'docker cp . node_builder:/usr/src/app'
                
                // Instala dependencias y compila la app
                sh '''
                    docker exec node_builder bash -c "
                        cd /usr/src/app && \
                        npm install && \
                        npm run build
                    "
                '''
            }
        }

        stage('Test') {
            steps {
                // Ejecuta los tests en el contenedor Node
                sh '''
                    docker exec node_builder bash -c "
                        cd /usr/src/app && \
                        npm test
                    "
                '''
            }
        }

        stage('Deploy') {
            steps {
                // La carpeta 'build' ya está en el volumen compartido,
                // Apache la sirve automáticamente.
                echo "Despliegue completado. Revisa el contenedor Apache."
            }
        }
    }
}
